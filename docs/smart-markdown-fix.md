# Умное исправление Markdown

## Проблема

LLM иногда генерирует сообщения с некорректным Telegram MarkdownV2 форматированием — непарными символами `_`, `*`, `__`, `~`, и т.д. Telegram возвращает ошибку с указанием типа проблемного символа и его позиции в байтах.

**Ключевое наблюдение:** Когда в сообщении несколько ошибок, после исправления одной появляется следующая:
```
WARNING: ошибка парсинга: Underline entity at byte offset 1959
WARNING: исправление не помогло: Bold entity at byte offset 2114
```

Offset увеличился (1959 → 2114) — значит первое исправление **сработало**, просто есть еще ошибки!

## Решение

Система автоматически исправляет markdown **последовательно**:

1. **Парсинг ошибки** — извлекаем тип символа (`Underline` → `__`) и позицию ошибки
2. **Целенаправленное исправление** — находим непарный символ около указанной позиции и экранируем его
3. **Повтор до 7 раз** — если после исправления снова ошибка, повторяем процесс
4. **Fallback** — если не помогло, пробуем общее исправление markdown
5. **Последний шанс** — отправка без форматирования

### Как определяем непарный символ

Открывающий `_слово`:
- После пробела/начала строки
- Перед не-пробелом

Закрывающий `слово_`:
- После не-пробела  
- Перед пробелом/концом/знаком препинания

Система составляет пары и экранирует **только непарные** символы, сохраняя валидный markdown.

## Примеры

### Несколько последовательных ошибок

**Исходный текст:**
```
Текст с __непарным подчеркиванием и *непарным жирным
```

**Процесс:**
- **Попытка 1:** Ошибка `Underline at 1959` → исправление → `\__непарным`
- **Попытка 2:** Ошибка `Bold at 2114` → исправление → `\*непарным` 
- **Попытка 3:** ✅ Успешно отправлено!

**Логи:**
```
INFO: попытка 1/7: символ '__' на позиции 1959
INFO: попытка 2/7: символ '*' на позиции 2114
```

### Сохранение валидных тегов

**Исходный текст:**
```
_первый тег_ _второй тег _третий непарный
```

**Результат:**
```
_первый тег_ _второй тег \_третий непарный
```

Первые две пары остаются без изменений, экранируется только непарный символ.

## Преимущества

**До:**
- Одна попытка исправления
- Если несколько ошибок → отправка без форматирования
- Могли экранироваться валидные теги

**После:**
- ✅ До 7 целенаправленных попыток
- ✅ Автоматическая обработка множественных ошибок
- ✅ Сохранение валидного markdown
- ✅ Корректная работа с UTF-8 (кириллица, эмодзи)
- ✅ Прогрессивное исправление — каждая попытка улучшает текст

## API

### Основные функции

- `parse_telegram_error(error_message)` — извлекает тип символа и позицию из ошибки
- `fix_markdown_at_offset(text, char, offset)` — исправляет конкретный непарный символ
- `fix_nested_markdown(text)` — общее исправление markdown (fallback)
- `send_message_with_fallback(chat_id, text, max_fix_attempts=7)` — отправка с автоисправлением

### Поддерживаемые типы

- `Underline` → `__` (подчеркивание)
- `Bold` → `*` (жирный)
- `Italic` → `_` (курсив)
- `Strikethrough` → `~` (зачеркнутый)
- `Code` → `` ` `` (моноширинный)
- `Spoiler` → `||` (спойлер)

## Тестирование

**29 тестов**, покрытие 100%:
- Парсинг ошибок Telegram
- Исправление непарных символов
- UTF-8 и эмодзи
- Множественные последовательные ошибки
- Интеграционные тесты

```bash
pytest tests/test_telegram_error_parsing.py -v
```

## Логирование

**Успешное исправление:**
```
INFO: попытка 1/7: символ '__' на позиции 1959
INFO: попытка 2/7: символ '*' на позиции 2114
✅ Отправлено после 2 попыток
```

**Fallback к общему исправлению:**
```
WARNING: исчерпаны попытки (7). Пробуем общее исправление...
✅ Отправлено после общего исправления
```

**Последний вариант:**
```
WARNING: общее исправление не помогло
WARNING: отправляем без форматирования
```
