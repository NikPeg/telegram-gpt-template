# üîÑ –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

## üìã –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
2. –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ –º–∏–≥—Ä–∞—Ü–∏–∏
3. –§–∞–∫—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `migrations`

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
migrations/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ migration_manager.py           # –ú–µ–Ω–µ–¥–∂–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–π
‚îî‚îÄ‚îÄ migration_001_*.py              # –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
```

## üìù –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### Migration 001: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ timestamp –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º

**–î–∞—Ç–∞:** 2025-11-05  
**–§–∞–π–ª:** `migration_001_add_timestamp_to_messages.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ `timestamp` –∫–æ –≤—Å–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –≤ –∏—Å—Ç–æ—Ä–∏–∏
- –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `timestamp: null`
- –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—É—á–∞—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –î–û:**
```json
{
  "role": "user",
  "content": "–ü—Ä–∏–≤–µ—Ç!"
}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ü–û–°–õ–ï:**
```json
{
  "role": "user",
  "content": "–ü—Ä–∏–≤–µ—Ç!",
  "timestamp": "2025-11-05 15:30:45"
}
```

**–î–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:**
```json
{
  "role": "user",
  "content": "–ü—Ä–∏–≤–µ—Ç!",
  "timestamp": null
}
```

## üöÄ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:
```bash
python main.py
```

### –í—Ä—É—á–Ω—É—é

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç–¥–µ–ª—å–Ω–æ:
```bash
python -m migrations.migration_manager
```

### –í Docker

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Docker –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
```bash
docker-compose up -d
```

## ‚úçÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `migration_XXX_description.py` –≤ –ø–∞–ø–∫–µ `migrations/`
2. –ù–æ–º–µ—Ä XXX –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –ø–æ –ø–æ—Ä—è–¥–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 002)
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `migrate(db)`:

```python
"""
–û–ø–∏—Å–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏.
"""

import aiosqlite

async def migrate(db: aiosqlite.Connection):
    """
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é.
    
    Args:
        db: –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    """
    # –í–∞—à –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–∏
    await db.execute("...")
    await db.commit()
    print("  ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞")
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π

–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:

```python
import asyncio
import aiosqlite

async def check_migrations():
    async with aiosqlite.connect("users.db") as db:
        async with db.execute("SELECT * FROM migrations ORDER BY id") as cursor:
            migrations = await cursor.fetchall()
            for migration in migrations:
                print(f"{migration[0]}: {migration[1]} (–ø—Ä–∏–º–µ–Ω–µ–Ω–∞: {migration[2]})")

asyncio.run(check_migrations())
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–π—Ç–µ** –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
2. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏–∑–º–µ–Ω—è–π—Ç–µ** –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
3. **–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–ø–∏–∏ –±–∞–∑—ã –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º
4. **–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π

## üîß –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ—ç—Ç–æ–º—É:
- –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
cp users.db users.db.backup

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker-compose exec bot cp /app/users.db /app/users.db.backup
```

## üìä –¢–∞–±–ª–∏—Ü–∞ migrations

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ:

```sql
CREATE TABLE migrations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | INTEGER | ID –º–∏–≥—Ä–∞—Ü–∏–∏ (–∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç) |
| `name` | TEXT | –ò–º—è —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ |
| `applied_at` | TIMESTAMP | –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è |

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `migration_`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `migrate`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs -f`

### –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ë–î –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
3. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞

### –ù—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ–≤—Ç–æ—Ä–Ω–æ

1. –£–¥–∞–ª–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `migrations`:
```sql
DELETE FROM migrations WHERE name = 'migration_XXX_...';
```
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç

## üîó –°–º. —Ç–∞–∫–∂–µ

- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](deployment.md#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
- [–î–µ–ø–ª–æ–π –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ](deployment.md)
- [CI/CD Pipeline](ci-cd.md)

