# Настройка логирования

## Переменные окружения для настройки логирования

В `.env` файле можно настроить уровни логирования для разных выходов:

```bash
# Основной уровень логирования (по умолчанию: INFO)
LOG_LEVEL=INFO

# Уровень для вывода в консоль (по умолчанию: берется из LOG_LEVEL)
CONSOLE_LOG_LEVEL=INFO

# Уровень для записи в файл debug.log (по умолчанию: DEBUG)
FILE_LOG_LEVEL=DEBUG
```

## Доступные уровни логирования

- **DEBUG** - максимально подробное логирование, включая полные промпты
- **INFO** - информационные сообщения, системные промпты, статистика
- **WARNING** - предупреждения
- **ERROR** - ошибки
- **CRITICAL** - критические ошибки

## Примеры конфигураций

### 1. Разработка (полное логирование)
```bash
LOG_LEVEL=DEBUG
CONSOLE_LOG_LEVEL=DEBUG
FILE_LOG_LEVEL=DEBUG
```
**Результат:** Все логи выводятся и в консоль, и в файл

### 2. Production (минимум в консоль, детали в файл)
```bash
LOG_LEVEL=INFO
CONSOLE_LOG_LEVEL=WARNING
FILE_LOG_LEVEL=DEBUG
```
**Результат:** В консоли только предупреждения и ошибки, в файле полная информация

### 3. Отладка промптов (просмотр полных промптов)
```bash
LOG_LEVEL=DEBUG
FILE_LOG_LEVEL=DEBUG
```
**Результат:** В файле `debug.log` будут видны полные промпты с историей диалога

### 4. Просмотр только системных промптов
```bash
LOG_LEVEL=INFO
FILE_LOG_LEVEL=INFO
```
**Результат:** В логах только системные промпты без истории диалога

## Типы логов промптов

### DEBUG уровень

#### `PROMPT_FULL_MESSAGE<chat_id>`
Полный промпт со всей историей диалога в JSON формате для обычных сообщений.

**Пример:**
```
PROMPT_FULL_MESSAGE123456: [
  {
    "role": "user",
    "content": "Привет!"
  },
  {
    "role": "assistant",
    "content": "Привет! Как дела?"
  },
  {
    "role": "system",
    "content": "1. Ты общительный ассистент..."
  }
]
```

#### `PROMPT_FULL_REMINDER<chat_id>`
Полный промпт со всей историей для напоминаний.

### INFO уровень

#### `PROMPT_SYSTEM_MESSAGE<chat_id>`
Только системные промпты без истории диалога для обычных сообщений.

**Пример:**
```
PROMPT_SYSTEM_MESSAGE123456: [{"role": "system", "content": "1. Ты общительный ассистент... 5. Текущая дата: 2025-11-05 14:30:00 6. Ник пользователя: @username"}]
```

#### `PROMPT_SYSTEM_REMINDER<chat_id>`
Только системные промпты для напоминаний.

#### `PROMPT_STATS_MESSAGE<chat_id>`
Статистика промпта для обычных сообщений.

**Пример:**
```
PROMPT_STATS_MESSAGE123456: messages={user: 5, assistant: 4, system: 1}, total_chars=2450
```

#### `PROMPT_STATS_REMINDER<chat_id>`
Статистика промпта для напоминаний.

## Где хранятся логи

- **Консоль:** Вывод в stdout (управляется `CONSOLE_LOG_LEVEL`)
- **Файл:** `debug.log` в корне проекта (управляется `FILE_LOG_LEVEL`)
- **Ротация:** Файл автоматически ротируется при достижении 1MB, хранится до 5 архивных копий

## Полезные команды

### Просмотр логов в реальном времени
```bash
tail -f debug.log
```

### Поиск промптов конкретного пользователя
```bash
grep "PROMPT.*123456" debug.log
```

### Просмотр только полных промптов
```bash
grep "PROMPT_FULL" debug.log
```

### Просмотр статистики промптов
```bash
grep "PROMPT_STATS" debug.log
```

### Просмотр системных промптов без истории
```bash
grep "PROMPT_SYSTEM" debug.log | jq .
```

## Устранение неполадок

### Промпты не появляются в логах

**Проблема:** После настройки `FILE_LOG_LEVEL=DEBUG` промпты (`PROMPT_FULL_*`, `PROMPT_SYSTEM_*`) не появляются в `debug.log`.

**Причина:** Бот не был перезапущен после изменения `.env` файла.

**Решение:**
```bash
# Если запущено локально
# Нажмите Ctrl+C и запустите снова
python main.py

# Если запущено в Docker
docker-compose restart

# Проверьте, что настройки применились
grep "Logger initialized" debug.log
# Должна быть строка типа:
# Logger initialized: LOG_LEVEL=INFO, CONSOLE=INFO, FILE=DEBUG
```

### Видны только INFO логи, но нет DEBUG

**Проблема:** В `debug.log` есть `PROMPT_SYSTEM_*` и `PROMPT_STATS_*`, но нет `PROMPT_FULL_*`.

**Причина:** `FILE_LOG_LEVEL` не установлен в `DEBUG`.

**Решение:**
```bash
# В .env добавьте или измените
FILE_LOG_LEVEL=DEBUG

# Перезапустите бот
```

### Слишком много логов, файл быстро растет

**Проблема:** Файл `debug.log` быстро достигает 1MB и создается много backup файлов.

**Решение:**
```bash
# Уменьшите детализацию
FILE_LOG_LEVEL=INFO  # вместо DEBUG

# Или увеличьте размер файла в config.py
# Найдите строку: maxBytes=1024 * 1024
# Измените на: maxBytes=5 * 1024 * 1024  # 5MB
```

## Рекомендации

1. **Production окружение:**
   - `CONSOLE_LOG_LEVEL=WARNING` - минимум шума в консоли
   - `FILE_LOG_LEVEL=INFO` - достаточно для мониторинга, без переполнения диска

2. **Отладка проблем с LLM:**
   - Установите `FILE_LOG_LEVEL=DEBUG`
   - **Обязательно перезапустите бот!**
   - Найдите логи `PROMPT_FULL_*` для конкретного пользователя
   - Проверьте что отправляется в LLM

3. **Мониторинг:**
   - `PROMPT_STATS_*` логи помогут отслеживать длину контекста
   - Следите за `total_chars` чтобы не превысить лимиты LLM

4. **Безопасность:**
   - Помните, что логи уровня DEBUG содержат полную историю диалога
   - Защитите файл `debug.log` от несанкционированного доступа
   
5. **После изменения .env:**
   - **ВСЕГДА перезапускайте бот** для применения изменений
   - Проверяйте строку "Logger initialized" в логах

