# Скрипты для работы с ботом

Набор утилит для управления базой данных и другими компонентами бота.

## Список скриптов

### `add_user.sh`

Скрипт для ручного добавления пользователей и групповых чатов в базу данных.

### `test_model.py`

Скрипт для тестирования доступности моделей через OpenRouter API.

**Использование:**

```bash
# Из корня проекта
python scripts/test_model.py

# Или напрямую (если есть права на исполнение)
./scripts/test_model.py
```

**Что делает:**
1. Работает в бесконечном цикле, позволяя тестировать несколько моделей подряд
2. Запрашивает название модели через input()
3. Отправляет тестовый запрос к модели через OpenRouter API
4. Выводит ответ модели при успехе или описание ошибки при неудаче
5. Для выхода нужно ввести `exit`

**Примеры моделей:**
- `deepseek/deepseek-chat` - DeepSeek Chat
- `anthropic/claude-3.5-sonnet` - Claude 3.5 Sonnet
- `openai/gpt-4o` - GPT-4o
- `google/gemini-2.0-flash-001` - Gemini 2.0 Flash
- `meta-llama/llama-3.1-70b-instruct` - Llama 3.1 70B

**Примечания:**
- Требует наличия `LLM_TOKEN` в `.env` файле
- Использует тот же подход к работе с API, что и основной код бота
- Полезен для проверки доступности моделей из РФ

---

**Использование:**

```bash
# Добавить личного пользователя
./add_user.sh USER7581829366
./add_user.sh 7581829366

# Добавить групповой чат
./add_user.sh USER-1003209384984
./add_user.sh -1003209384984
```

**Параметры по умолчанию:**
- `name`: NULL (автоматически обновится при первом сообщении)
- `active_messages_count`: NULL (все сообщения в контексте)
- `subscription_verified`: NULL (подписка не проверялась)
- `referral_code`: NULL (без реферального кода)

**Что делает:**
1. Проверяет формат ID (поддерживает отрицательные ID для чатов)
2. Проверяет существование пользователя/чата в базе
3. Если не существует - добавляет с базовыми параметрами
4. Выводит статус операции

**Примечания:**
- Имя пользователя/чата обновится автоматически из Telegram при первом сообщении
- Напоминания включены по умолчанию (отправка в 19:15 МСК)
- Пользователь может отключить напоминания командой `/mute`

---

## Прямые SQL запросы

Если нужно работать напрямую с базой:

```bash
# Подключение к базе
sqlite3 users.db

# Или из папки scripts/
sqlite3 ../users.db
```

### Полезные запросы:

```sql
-- Количество пользователей
SELECT COUNT(*) FROM conversations;

-- Только личные пользователи (ID > 0)
SELECT COUNT(*) FROM conversations WHERE id > 0;

-- Только групповые чаты (ID < 0)
SELECT COUNT(*) FROM conversations WHERE id < 0;

-- Список всех пользователей с именами
SELECT id, name, active_messages_count FROM conversations;

-- Проверить конкретного пользователя
SELECT * FROM conversations WHERE id = 7581829366;

-- Добавить пользователя вручную
INSERT INTO conversations (id, name, active_messages_count, subscription_verified, referral_code)
VALUES (7581829366, NULL, NULL, NULL, NULL);

-- Удалить пользователя
DELETE FROM conversations WHERE id = 7581829366;
DELETE FROM messages WHERE user_id = 7581829366;
```

---

## Структура базы данных

### Таблица `conversations`

Основная таблица с информацией о пользователях и чатах:

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | ID пользователя (>0) или чата (<0) |
| `name` | TEXT | Имя пользователя или название чата |
| `active_messages_count` | INTEGER | Количество активных сообщений в контексте (NULL = все, 0 = забыть, N = последние N) |
| `subscription_verified` | INTEGER | Статус подписки (NULL = не проверялось, 0 = не подписан, 1 = подписан) |
| `referral_code` | TEXT | Реферальный код, по которому пользователь перешел в бота |

### Таблица `messages`

История сообщений:

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | Уникальный ID сообщения |
| `user_id` | INTEGER | ID пользователя/чата |
| `role` | TEXT | Роль (user/assistant) |
| `content` | TEXT | Содержимое сообщения |
| `timestamp` | TEXT | Время отправки |

### Таблица `chat_verifications`

Верификация групповых чатов:

| Поле | Тип | Описание |
|------|-----|----------|
| `chat_id` | INTEGER | ID чата (отрицательный) |
| `verified_by_user_id` | INTEGER | ID пользователя, подтвердившего подписку |
| `verified_at` | TEXT | Дата верификации |
| `user_name` | TEXT | Имя верификатора |

---

## Добавление новых скриптов

При создании новых скриптов:

1. Добавляйте подробный комментарий в начале файла
2. Используйте относительные пути к базе данных
3. Добавляйте проверки на существование файлов/записей
4. Выводите понятные сообщения об ошибках
5. Обновляйте этот README
6. Делайте скрипт исполняемым: `chmod +x script_name.sh`

**Пример заголовка:**

```bash
#!/bin/bash
# Краткое описание скрипта
# Использование: ./script_name.sh [аргументы]
```

